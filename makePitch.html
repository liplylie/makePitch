<html>
<head>
  <script type="text/javascript">

    const webaudio_tooling_obj = () => {

      const audioContext = new AudioContext()

      console.log("audio is starting")

      const BUFF_SIZE = 16384
      let audioInput
      let gain_node = audioContext.createGain()
        gain_node.gain.value = 0.5
      let script_processor_node = audioContext.createScriptProcessor(BUFF_SIZE, 1, 1)
      let script_processor_fft_node = audioContext.createScriptProcessor(2048, 1, 1)
      let analyserNode = audioContext.createAnalyser()

      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||navigator.mozGetUserMedia || navigator.msGetUserMedia

      if (navigator.getUserMedia){
        navigator.getUserMedia({audio:true}, (stream) => {
          start_microphone(stream);
        },
        (error) => {
          alert('Error capturing audio.');
        });

      } else { 
        alert('getUserMedia not supported in this browser.')
      }

      const start_microphone = (stream) => {

        gain_node.connect( audioContext.destination );
        let microphone_stream = audioContext.createMediaStreamSource(stream)
        //microphone_stream.connect(gain_node); 
        script_processor_node.onaudioprocess = process_microphone_buffer;

        microphone_stream.connect(script_processor_node);

        // --- setup FFT

        script_processor_fft_node.connect(gain_node);

        analyserNode.smoothingTimeConstant = 0;
        analyserNode.fftSize = 2048;

        microphone_stream.connect(analyserNode);

        analyserNode.connect(script_processor_fft_node);

        script_processor_fft_node.onaudioprocess = function() {

          // get the average for the first channel
          var array = new Uint8Array(analyserNode.frequencyBinCount);
          analyserNode.getByteFrequencyData(array);

          // draw the spectrogram
          if (microphone_stream.playbackState == microphone_stream.PLAYING_STATE) {

              show_some_data(array, 5, "from fft asdfasdf");
          }
        };
      }

      const show_some_data = (given_typed_array, num_row_to_display, label) => {

        var size_buffer = given_typed_array.length
        var index = 0
        var max_index = num_row_to_display

        console.log("__________ " + label)

        for (; index < max_index && index < size_buffer; index += 1) {

            console.log(given_typed_array[index]);
        }
      }

      const process_microphone_buffer = (event) => {

        const microphone_output_buffer = event.inputBuffer.getChannelData(0); // just mono - 1 channel for now

        // microphone_output_buffer  <-- this buffer contains current gulp of data size BUFF_SIZE

        show_some_data(microphone_output_buffer, 5, "from getChannelData");
      }

      
    }

    webaudio_tooling_obj()

  </script>

</head>
  <body>

    open chrome tool

  </body>
</html>